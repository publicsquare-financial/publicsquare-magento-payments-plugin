#!/usr/bin/env bash

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
ROOT_DIR="$( cd "${DIR}/.." >/dev/null 2>&1 && pwd )"

# Set install directory / magento version / host
MAGENTO_DIR="${1:-$ROOT_DIR/magento-install}"
DEFAULT_MAGENTO_VERSION="2.4.8-p3"
# Allow MAGENTO_VERSION to be overridden via environment variable,
# otherwise fall back to CLI arg 2, then to DEFAULT_MAGENTO_VERSION.
MAGENTO_VERSION="${MAGENTO_VERSION:-${2:-$DEFAULT_MAGENTO_VERSION}}"
MAGENTO_HOST="${3:-magento.test}"

# Common Magento paths
MAGENTO_BIN="${MAGENTO_DIR}/bin/magento"
MAGENTO_CLI="${MAGENTO_DIR}/bin/cli"
MAGENTO_INIT="${MAGENTO_DIR}/bin/init"
MAGENTO_RESTART="${MAGENTO_DIR}/bin/restart"
MAGENTO_CREATE_USER="${MAGENTO_DIR}/bin/create-user"

set -euo pipefail

# Accept keys via environment variables when provided (e.g., CI), otherwise prompt interactively
PUBLICSQUARE_PUBLIC_KEY="${PUBLICSQUARE_PUBLIC_KEY:-}"
PUBLICSQUARE_SECRET_KEY="${PUBLICSQUARE_SECRET_KEY:-}"

if [[ -z "${PUBLICSQUARE_PUBLIC_KEY}" || -z "${PUBLICSQUARE_SECRET_KEY}" ]]; then
  # Use silent input so keys are not echoed to the terminal
  read -rsp "Enter PublicSquare PUBLIC key: " PUBLICSQUARE_PUBLIC_KEY
  echo
  read -rsp "Enter PublicSquare SECRET key: " PUBLICSQUARE_SECRET_KEY
  echo
fi

# Ensure Magento is already installed in the target directory (handled by bin/it-up)
if [[ ! -d "${MAGENTO_DIR}" || ! -x "${MAGENTO_DIR}/bin/magento" ]]; then
  echo "Magento installation not found in '${MAGENTO_DIR}'."
  echo "Run './bin/it-up' first to perform the initial Magento setup."
  exit 1
fi

echo "Using Magento install directory: ${MAGENTO_DIR}"
cd "${MAGENTO_DIR}"

# Set mode to production
"${MAGENTO_BIN}" "deploy:mode:set" "production" 

# Create a user
"${MAGENTO_CREATE_USER}"

######

echo "Installing Magento (IT) using compose.yaml..."

echo "Initializing pre-reqs"
chmod +x "${MAGENTO_INIT}"
"${MAGENTO_INIT}"
"${MAGENTO_BIN}"  module:enable Magento_SampleData
"${MAGENTO_BIN}"  module:enable Magento_BundleSampleData
"${MAGENTO_BIN}"  module:enable Magento_CatalogSampleData
"${MAGENTO_BIN}"  module:enable Magento_CmsSampleData
"${MAGENTO_BIN}"  setup:install
"${MAGENTO_BIN}"  setup:di:compile
"${MAGENTO_BIN}"  setup:static-content:deploy -f
"${MAGENTO_BIN}"  indexer:reindex
"${MAGENTO_BIN}"  cache:flush

echo "Pre-reqs complete"

# Set mode to developer
"${MAGENTO_BIN}" "deploy:mode:set" "developer"

# Map volumes to our new container and restart Magento (without yq)
PUBLICSQUARE_VOLUME="../PublicSquare/:/var/www/html/app/code/PublicSquare"

if grep -q "${PUBLICSQUARE_VOLUME}" "${MAGENTO_DIR}/compose.yaml"; then
  echo "PublicSquare volume mount already present in compose.yaml; skipping edit."
else
  echo "Adding PublicSquare volume mount to compose.yaml..."
  tmp_compose="${MAGENTO_DIR}/compose.yaml.tmp"
  awk -v vol="${PUBLICSQUARE_VOLUME}" '
    $0 ~ /^[[:space:]]*volumes:[[:space:]]*&appvolumes/ && !added {
      print
      print "      - " vol
      added = 1
      next
    }
    { print }
  ' "${MAGENTO_DIR}/compose.yaml" > "${tmp_compose}"
  mv "${tmp_compose}" "${MAGENTO_DIR}/compose.yaml"
fi

"${MAGENTO_RESTART}"  

# Enable PublicSquare Payment module
echo "Installing PublicSquare Module"
"${MAGENTO_CLI}" \
  bin/magento module:enable PublicSquare_Payments || true
"${MAGENTO_CLI}" \
  bin/magento setup:upgrade
"${MAGENTO_CLI}" \
  bin/magento setup:di:compile
"${MAGENTO_CLI}" \
  bin/magento indexer:reindex
"${MAGENTO_CLI}" bin/magento cache:flush

echo "Deploying static content (IT)..."
"${MAGENTO_CLI}" \
  php -d memory_limit=2G bin/magento setup:static-content:deploy -f
"${MAGENTO_CLI}" bin/magento cache:flush

echo "Configuring PublicSquare API keys and enabling payment method..."
"${MAGENTO_CLI}" \
  bin/magento config:set --scope=default payment/publicsquare_payments/publicsquare_api_public_key "$PUBLICSQUARE_PUBLIC_KEY"
"${MAGENTO_CLI}" \
  bin/magento config:set --scope=default payment/publicsquare_payments/publicsquare_api_secret_key "$PUBLICSQUARE_SECRET_KEY"
"${MAGENTO_CLI}" \
  bin/magento config:set --scope=default payment/publicsquare_payments/active 1
"${MAGENTO_CLI}" bin/magento cache:flush

echo "Disabling Two-Factor Auth for admin..."
"${MAGENTO_CLI}" \
  bin/magento module:disable Magento_AdminAdobeImsTwoFactorAuth Magento_TwoFactorAuth || true
"${MAGENTO_CLI}" bin/magento cache:flush

echo "Enabling Vault for saved cards..."
"${MAGENTO_CLI}" \
  bin/magento config:set payment/publicsquare_payments_cc_vault/active 1 || true
"${MAGENTO_CLI}" bin/magento cache:flush

echo "Disabling SMTP to avoid email send failures in IT..."
"${MAGENTO_CLI}" \
  bin/magento config:set system/smtp/disable 1 || true

# echo "Enabling Flat Rate and Free Shipping..."
#"${MAGENTO_DIR}/bin/cli" bash -lc "bin/magento config:set carriers/flatrate/active 1 && \
#  bin/magento config:set carriers/flatrate/price 0 && \
#  bin/magento config:set carriers/flatrate/type I && \
#  bin/magento config:set carriers/flatrate/name 'Flat Rate' && \
#  bin/magento config:set carriers/freeshipping/active 1 && \
#  bin/magento config:set carriers/freeshipping/free_shipping_subtotal 0 && \
#  bin/magento cache:flush"

cd "${DIR}"
echo "IT install complete. You may now access Magento at https://${MAGENTO_HOST}"
open "https://${MAGENTO_HOST}" || true
